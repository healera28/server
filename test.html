<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>


    <div class="hero">
        <form class="auth-form">
            <div class="center-block">
                <h3>Авторизация</h3>
            </div>
            <div class="mb-3">
                <label for="email-input" class="form-label">Почта</label>
                <input type="email" class="form-control" id="emailInput" placeholder="example@mail.ru">
            </div>
            <div class="mb-3">
                <label for="password-input" class="form-label">Пароль</label>
                <input type="password" class="form-control" id="passwordInput" placeholder="*******">
            </div>
            <div class="center-block">
                <p id="inputError"></p>
                <button class="btn btn-primary mb-3">Войти</button>
                <p class="forgot-password">Забыли пароль?</p>
            </div>
        </form>
    </div>
    <script>
        const ENDPOINT = "http://localhost:8000/api";

        const waitForElement = function (selector, callback) {
            const element = document.querySelector(selector);
            if (element) {
                callback(element);
            } else {
                setTimeout(function () {
                    waitForElement(selector, callback);
                }, 100); // Check every 100ms
            }
        };

        waitForElement('.super-root', function (superPage) {
            const contentFrame = document.querySelector(".frame-content");
            const hero = document.querySelector(".hero");
            const form = document.querySelector(".auth-form");
            const email = form.emailInput;
            const password = form.passwordInput;
            const error = document.querySelector("#inputError");

            let isAuth = localStorage.getItem("user");

            if (isAuth) {
                authenticate();
            }

            function authenticate() {
                console.log("AUTHENTICATE");
                hero.style.display = "none";
                document.body.style.overflow = "visible";
                superPage.style.display = "block";
            }

            function logout() {
                console.log("LOGOUT");
                localStorage.removeItem("user");
                hero.style.display = "block";
                document.body.style.overflow = "hidden";

                superPage.style.display = "none";
            }

            form.addEventListener("submit", async e => {
                e.preventDefault()

                if (email.value && password.value) {
                    const response = await fetchAuthUser({email: email.value, password: password.value})
                } else {
                    error.innerHTML = "Заполните все поля";
                }
            })

            async function fetchAuthUser({
                email,
                password
            }) {
                const response = await fetch(`${ENDPOINT}/signin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email.value,
                        password: password.value
                    })
                });

                if (response.ok) {
                    localStorage.setItem("user", {email: email.value, password: password.value})
                    authenticate()
                } else {
                    return (await response.json()).message
                }
            }
        })

    </script>
</body>

</html>